<div class="span8">
	<h1><%= @document.title %></h1>

	<div id="textcontent">
		<%= @document.description.html_safe %>
	</div>

	<div class="form-actions">
	  <%= link_to 'Back', collection_documents_path, :class => 'btn'  %>
	  <%= link_to 'Edit', edit_collection_document_path(@collection, @document), :class => 'btn' %>
	  <%= link_to 'Delete', collection_document_path(@collection, @document), :method => 'delete', :confirm => 'Are you sure?', :class => 'btn btn-danger'%>
	</div>
</div><!--/span8 -->
<div class="span4">
    <a class="btn btn-mini" data-toggle="modal" href="#markdown" >Formatting guide</a>
	<div id="annotation-well" class="well sidebar-nav sidebar-nav-fixed">
		<em><a href="#list" class="trigger">refresh</a></em>
		<h3>Annotations</h3>
		<%# render "documents/annotation_list" %>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.0/jquery-1.8.0.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.4.2/mustache.min.js"></script>
		<%= javascript_include_tag "sidebar" %>
		<ul id="annotation-list">
		</ul>
		<script type="text/template" id="annotation-template">
		<a id="sb{{id}}" href="#hl{{id}}" rel="tooltip" title="{{user}}" class="highlightlink">{{{quote}}}</a>
		</script>
		</div><!--/well -->
</div><!--/span4 -->
<%= javascript_include_tag "documents" %>
<script type="text/javascript" charset="utf-8">
	jQuery(function ($) {
		$('#textcontent').annotator()
			.annotator('setupPlugins', {}, {
			Auth: {
				token: '<%= @jwt %>'
			},
			Store: {
				prefix: 'http://annotations.herokuapp.com/api',
				// prefix: 'http://localhost:5000/api',
			},
			Filter: false,
			Markdown: true,
		});
		$(document).ready(function () {
			// Get a reference to the Annotator for event callback subscriptions //
			var studio = $('#textcontent').annotator().data('annotator');

			// Bootstrap Backbone Sidebar //
			var sidebar = new Sidebar.App();
			Backbone.history.start({pushState: true, root: window.location})

			// Callback for Annotator subscriptions: add ids to highlights. //
			var addHighlightId;
			var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };
			addHighlightId = __bind(function(a) {
				if (a.highlights[0] != null) {
					a.highlights[0].id = "hl"+ a.id;
					a.highlights[0].title = a.user;
				}
			}, this);

			// Subscribe to annotator events for ID additions. //
			studio.subscribe('annotationUpdated', addHighlightId);
			studio.subscribe('annotationCreated', addHighlightId);
			studio.subscribe('annotationsLoaded', __bind(function(annotations) {
				annotations.map(addHighlightId);
			}, this));

			// Callback to update the sidebar. //
			var updateSidebar =	function() {
				sidebar.listAnnotations(studio.dumpAnnotations());
			};

			// Subscribe to annotator events to update sidebar. //
			studio.subscribe('annotationsLoaded', updateSidebar);
			// studio.subscribe('annotationUpdated', updateSidebar);
			// studio.subscribe('annotationCreated', updateSidebar);
			// studio.subscribe('annotationDeleted', updateSidebar);

			// Bind some events to links
			$("span.annotator-hl").click(function(event){		
				event.preventDefault();
				$("ul.annotation-list li").removeClass('hover');
				$("a.highlightlink").tooltip('hide');
				var str = this.id.toString();
				var parts = str.match(/(hl)(.+)/).slice(1);
				var targetid = "#sb" + parts[1];

				// TODO: deal with the events in a more organized way (recompose them in functions)
				$('div.well').animate({scrollTop:$(targetid).offset().top}, 100, function (){
					$(targetid).parent().addClass('hover');
					// $(targetid).tooltip('show');
				});
			});

			// Bind some events to links
			$('a.highlightlink').tooltip({placement:'right'});

			// Bind some events to links
			// TODO: make the LI the click target, not the finicky little a tag.
			$("a.highlightlink").click(function(event){
				event.preventDefault();
				$("a.highlightlink").tooltip('hide');
				$("ul.annotation-list li").removeClass('hover');
				var idtarget = this.hash;
				// var linkTop = $(this).offset().top
				// Note: we can add a callback parameter to run when animation completes.
				$('html,body').animate({scrollTop: $(idtarget).offset().top - 85}, 2000);
			});
			
		});
	});
</script>
<%# render "documents/markdown" %>
<div class="modal hide fade" id="markdown">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">Ã—</button>
    <h3>Markdown Syntax</h3>
    <h4>(for adding images, links, formatting to your annotations)</h4>
  </div>
  <div class="modal-body">
	<h4>Links</h4>
	<pre><code>
	This is [an example](http://example.com/) inline link.
	</code></pre>

	<h4>Emphasis</h4>
	<pre><code>
	*single asterisks or underscores are italics*
	__double asterisks or underscores are bold__
	</code></pre>

	<h4>Images</h4>
	<pre><code>
	![Alt text](/path/to/img.jpg)
	</code></pre>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
  </div>
</div>