<div class="span8">
	<h1><%= @document.title %></h1>

	<div id="textcontent">
		<div><!-- Required for cases in which there's no HTML in the text -->
			<%= @document.text.html_safe %>
		</div>
	</div>

	<div class="form-actions">
		<%= link_to 'Back', documents_path, :class => 'btn'  %>
		<% if can? :manage, @document %>
		<%= link_to 'Edit', edit_document_path(@document), :class => 'btn' %>
		<%= link_to 'Delete', document_path(@document), :method => 'delete', :confirm => 'Are you sure?', :class => 'btn btn-danger'%>
		<% end %>	
	</div>
</div><!--/span8 -->
<%# javascript_include_tag "documents" %>
<div class="span4">
	<div id="annotation-well" class="well sidebar-nav sidebar-nav-fixed">
		<h3>Annotations</h3>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.4.2/mustache.min.js"></script>

		<ul id="annotation-list"></ul>
		<script type="text/template" id="comment-template">
			<span id="sb{{id}}" data-toggle="collapse" data-parent="#annotation-list" href="#full{{id}}" data-highlight="#hl{{id}}" rel="tooltip" title="{{user}}" class="highlightlink comment">{{{text}}}</span>
			<span id="quote{{id}}" class="sbquote details">{{{quote}}}</span>
			<span id="text{{id}}" class="sbtext details">{{{text}}}</span>
			<div id="tags{{id}}" class="sbtags details">{{#tags}}<span class="label">{{.}}</span> {{/tags}}</div>
		</script>
		<script type="text/template" id="highlight-template">
			<span id="sb{{id}}" data-highlight="#hl{{id}}" rel="tooltip" title="{{user}}" class="highlightlink highlight">{{{quote}}}</span>
			<span id="quote{{id}}" class="sbquote details">{{{quote}}}</span>
			<div id="tags{{id}}" class="sbtags details">{{#tags}}<span class="label">{{.}}</span> {{/tags}}</div>
		</script>
	</div><!--/well -->
</div><!--/span4 -->
<%= javascript_include_tag "sidebar" %>
<script type="text/javascript" charset="utf-8">
jQuery(function ($) {
	// Get a reference to the Annotator for event callback subscriptions //
	var studio = $('#textcontent').annotator();

	studio.annotator('addPlugin','Auth', {
		token: '<%= @jwt %>'
	});

	var groups = "<%= current_user.rep_group_list %>".split(/, /);
	
	studio.annotator('addPlugin','Store', {
		prefix: 'http://annotations.mit.edu/api',
		// prefix: 'http://localhost:5000/api',
		annotationData: {
			'uri': window.location.href,
			"groups": groups
		},
		loadFromSearch: {
			'limit': 1000,

			// Should load all of one's own annotations, 
			// plus all non-private group-shared annotations

			// Currently: all annotations within the group
			// That is, privacy considerations are ignored.

			'user':'<%= current_user.email %>',
			"groups": groups,
			'uri': window.location.href
		}
	});

	studio.annotator('addPlugin', 'Markdown');
	studio.annotator('addPlugin', 'Tags');
	studio.annotator('addPlugin', 'Unsupported');

	studio.annotator('addPlugin', 'Permissions', {
		user: '<%= current_user.email %>',
		permissions: {
			'read': ['<%= current_user.email %>'],
			'update': ['<%= current_user.email %>'],
			'delete': ['<%= current_user.email %>'],
			'admin': ['<%= current_user.email %>']
		},
		// Private/Public setting per-annotation
		showViewPermissionsCheckbox: true,
		
		// Review checkbox??
		showEditPermissionsCheckbox: false
	});

	var subscriber = $('#textcontent').annotator().data('annotator');

	// Bootstrap Backbone Sidebar //
	var sidebar = new Sidebar.App();
	Backbone.history.start({pushState: true, root: window.location})

	// Callback for Annotator subscriptions: add ids to highlights. //
	var addHighlightId;
	var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };
	addHighlightId = __bind(function(a) {
		if (a.highlights[0] != null) {
			a.highlights[0].id = "hl"+ a.id;
			a.highlights[0].title = a.user;
		}
	}, this);
	
	// Subscribe to annotator events for ID additions. //
	subscriber.subscribe('annotationUpdated', addHighlightId);
	subscriber.subscribe('annotationCreated', addHighlightId);
	subscriber.subscribe('annotationsLoaded', __bind(function(annotations) {
		annotations.map(addHighlightId);
	}, this));
	
	// Callback to update the sidebar. //
	var loadSidebar =	function() {
		sidebar.listAnnotations(subscriber.dumpAnnotations());
	};
	
	// Callback to update the sidebar. //
	var reloadSidebar =	function(annotation) {
		sidebar.listAnnotations(subscriber.dumpAnnotations());

		// subscriber.plugins.Store.loadAnnotationsFromSearch({
		// 	'limit': 1000,
		// 	'user':'<%= current_user.email %>',
		// 	"groups": groups,
		// 	'uri': window.location.href
		// });
	};
	
	var showAnnId =  function(annotation) {
		var newAnn = new Sidebar.Annotation(annotation);
		console.info(newAnn.get("id"));
	};
	
	// Subscribe to annotator events to update sidebar. //
	subscriber.subscribe('annotationsLoaded', loadSidebar);
	subscriber.subscribe('annotationUpdated', reloadSidebar);
	subscriber.subscribe('annotationCreated', reloadSidebar);
	subscriber.subscribe('annotationDeleted', reloadSidebar);
	
	mixpanel.track("Loaded Document");
});
</script>
<%= render "documents/markdown" %>