<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<title>Annotation Studio</title>

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
	<![endif]-->
	 <%= csrf_meta_tags %>

	 <%= stylesheet_link_tag	"application", :media => "all" %>

	 <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le fav and touch icons -->
	<link href="/favicon.ico" rel="shortcut icon" />
	<link href="images/apple-touch-icon.png" rel="apple-touch-icon" />
	<link href="images/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" />
	<%# link href="images/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" %>

	<%#
	<script type="text/javascript" src="http://use.typekit.com/zhn7yid.js"></script>
	<script type="text/javascript">try{Typekit.load();}catch(e){}</script>	</head>
 	%>
	<body data-spy="scroll" data-target=".subnav" data-offset="50" offset="50">
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>
				<a class="brand" href="/">Annotation Studio</a>
				<div class="container nav-collapse">
					<ul class="nav">
						<li><%= link_to "Collections", "/collections"	%></li>
					</ul>
					<a class="logo" href="/"><img src="/assets/hs-logo-trans-horiz.png"></a>
					<ul class="nav" id="accountlinks">
						<%= render 'devise/menu/registration_items' %>
						<%= render 'devise/menu/login_items' %>
					</ul>
				</div><!--/.nav-collapse -->
			</div><!--/.container -->
		</div><!--/.navbar-inner -->
	</div><!--/.navbar-fixed-top -->
	<div class="container">
		<div class="content">
		      <%- flash.each do |name, msg| -%>
		        <%= content_tag :div, msg, :class => "alert alert-#{name}" if msg.is_a?(String) %>
		      <%- end -%>
			<div class="row-fluid">
					<%= yield %>
			</div><!--/row-fluid -->
		<footer>
			<p>&copy; MIT 2012</p>
		</footer>
		</div><!--/content -->
	</div><!-- /container -->
	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<%= javascript_include_tag "application" %>
	<script type="text/javascript" charset="utf-8">
		jQuery(function ($) {
			$('#textcontent').annotator()
				.annotator('setupPlugins', {}, {
				Auth: {
					token: '<%= @jwt %>'
				},
				Store: {
					prefix: 'http://annotations.herokuapp.com/api',
					// prefix: 'http://localhost:5000/api',
					annotationData: {
						cssselect: "div#ch1",
					}
				},
				Filter: false,
				Markdown: true
			});
			$(document).ready(function () {
				var studio = $('#textcontent').annotator().data('annotator');
				// var marginalia = studio.plugins.Store.annotations;
				var addHighlightId;
				var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };
				addHighlightId = __bind(function(a) {
				  if (a.highlights[0] != null) {
				    a.highlights[0].id = "hl"+ a.id;
					a.highlights[0].title = a.user;
				  }
				}, this);
				studio.subscribe('annotationsLoaded', __bind(function(annotations) {
					annotations.map(addHighlightId);
				}, this));
				studio.subscribe('annotationUpdated', addHighlightId);

				// $('div#textcontent').tooltip({
				//	selector: 'span.annotator-hl',
				//	placement: 'left',
				//	trigger: 'manual'
				//});
				
				$("span.annotator-hl").click(function(event){		
					event.preventDefault();
					$("ul.annotation-list li").removeClass('hover');
					$("a.highlightlink").tooltip('hide');
					var str = this.id.toString();
					var parts = str.match(/(hl)(.+)/).slice(1);
					var targetid = "#sb" + parts[1];

					// Move the main text to the top
					//$('html,body').animate({scrollTop:$(this).offset().top - 85}, 2000);

					// Move the annotation sidebar to the top -- doesn't work most of the time, due to the height of the sidebar.
					// TODO: deal with the events in a more organized way (recompose them in functions)
					// Currently, highlight and hover events are confused (appearing, disappearing, scrolling, not happening, etc.)
					$('div.well').animate({scrollTop:$(targetid).offset().top}, 100, function (){
						$(targetid).parent().addClass('hover');
						// $(targetid).tooltip('show');
					});
				});
			});
		});
	</script>
	</body>
</html>
