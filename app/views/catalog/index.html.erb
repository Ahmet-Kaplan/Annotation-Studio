<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "application", :media => "all" %>
  <%= stylesheet_link_tag "catalog", :media => "all" %>
  <%= javascript_include_tag "application" %>
  <%= javascript_include_tag "tiny_mce_popup" %>
</head>
<body>

<div class="container-fluid catalog-container">

  <div class="col-lg-8">
    <form class="form-horizontal">

        <div class="form-group">
           <div class="input-group">
             <input id="search-term" class="form-control" type="text" value="<%= @search_term %>"/>
             <span class="input-group-btn">
                <button id="search-button" class="btn btn-default" type="button"><span class="glyphicon glyphicon-search"></span></button>
                <% if ( @search_term.nil? == false ) && ( @search_term.empty? == false ) %>
                   <a href="/documents/catalog" class="btn btn-default" type="button">Clear</a>
                <% end %>
             </span>
           </div>
        </div>

        <div class="form-group">
          <div class="btn-group btn-group-xs" data-toggle="buttons">
            <label id="search-both-label"class="btn btn-primary">
              <input id="search-both" type="radio" name="options" autocomplete="off" checked>Both
            </label>
            <label id="search-people-label" class="btn btn-primary">
              <input id="search-people" type="radio" name="options" autocomplete="off">People
            </label>
            <label id="search-artwork-label" class="btn btn-primary">
              <input id="search-artwork" type="radio" name="options" autocomplete="off">Artwork
            </label>
          </div>
        </div>

    </form>
  </div>

  <div class="col-lg-8">

    <div class="form-group">
      <div class="browse-panel pull-left">
        <label for="tag-tree"><span style="text-decoration: underline;">Browse:</span></label>
        <div id="tag-tree"></div>
      </div>
    </div>

      <div class="results-panel pull-right scrollable">

        <table id="people-results" class="table table-striped table-hover table-condensed">
          <thead>
            <tr><th><span style="text-decoration: underline;">People:</span></th><th>Name</th><th>Birth</th><th>Death</th></tr>
          </thead>
          <% unless @search_results[:person].nil? %>
          <tbody data-link="row" class="rowlink">
             <% @search_results[:person].each do | entry | %>
              <tr><td>
                <% if has_image( entry['image_thumb'] ) %>
                    <%= image_tag entry['image_thumb'] %>
                <% else %>
                  <span class="glyphicon glyphicon-user"></span>
                <% end %>
              </td><td><a id="<%= entry['eid'] %>" class="clickable" title="<%= tagset_display entry['name'] %>" ref="<%= entry['image_thumb'] %>"><%= tagset_display entry['name'] %></a></td><td><%= entry['birth'] %></td><td><%= entry['death'] %></td></tr>
             <% end %>
          </tbody>
          <% end %>
        </table>

        <table class="table table-striped table-hover table-condensed">
          <thead>
             <tr><th><span style="text-decoration: underline;">Artworks:</span></th><th>Artist</th><th>Title</th></tr>
          </thead>
          <% unless @search_results[:artwork].nil? %>
          <tbody data-link="row" class="rowlink">
            <% @search_results[:artwork].each do | entry | %>
               <tr><td>
                 <% if has_image( entry['image_thumb'] ) %>
                     <%= image_tag entry['image_thumb'] %>
                 <% else %>
                     <span class="glyphicon glyphicon-picture"></span>
                 <% end %>
               </td><td><a id="<%= entry['eid'] %>" class="clickable" title="<%= tagset_display entry['title'] %>" ref="<%= entry['image_thumb'] %>"><%= tagset_display entry['artist'] %></a></td><td><%= entry['title'] %></td></tr>
            <% end %>
          </tbody>
          <% end %>
        </table>

      </div>

  </div>
</div>

<script type="text/javascript">

    $('document').ready(function( ) {

        //
        // setup correct search radio buttons
        //
        <% if ( @search_types.include? :person ) && ( @search_types.include? :artwork ) %>
           $('#search-both').prop('checked', true);
           $('#search-both-label').addClass( "active")
        <% elsif @search_types.include? :person %>
           $('#search-people').prop('checked', true);
           $('#search-people-label').addClass( "active")
        <% elsif @search_types.include? :artwork %>
           $('#search-artwork').prop('checked', true);
           $('#search-artwork-label').addClass( "active")
        <% end %>

        // enable the tree view
        $('#tag-tree').treeview( { data: getTagTree( ), levels: 0, highlightSelected: false, nodeIcon: '', showTags: true, enableLinks: true } );

        // search button handler
        $("#search-button").click(function() {
            var term = $('#search-term').val( );
            var include_people = $('#search-people').prop('checked') || $('#search-both').prop('checked' );
            var include_artwork = $('#search-artwork').prop('checked') || $('#search-both').prop('checked' );
            newSearch( term, include_people, include_artwork );
        });

        // any of the results we found
        $(".clickable").click(function() {
            // the eid and the entry title separated with a pipe character
            var title = $(this).attr( "title" ).length === 0 ? "no title" : $(this).attr( "title");
            storeDetails( $(this).attr( "id") + "|" + title + "|" + $(this).attr( "ref") );

            // close the window...
            tinyMCEPopup.close( );
        });

        // when we select a tag
        $('#tag-tree').on('nodeSelected', function(event, node) {
            //alert( "Clicked tag");
        });
    });

    // doing a new search in the same frame
    function newSearch( term, include_people, include_artwork ) {
        var include = "";
        if( include_people ) { include = "people"; }
        if( include_artwork ) { include = ( include ? include + "," : "" ) + "artwork"; }
        var newURL = "/documents/catalog?term=" + encodeURI( term ) + "&onlyimages=<%= @onlyimages %>" + ( include ? "&types=" + include : "" );
        document.location.href = newURL;
    }

    // store the inserted item off so it is available to our parent (the opener)
    function storeDetails( reference ) {
       var parent = tinyMCEPopup.getWin( );
       var div = parent.jQuery('div')[ 0 ];
       parent.jQuery.data( div, "catalog", reference );
    }

    //
    // the tree view needs an array of json objects. Something like:
    //
    // [ { text: "Parent 1", nodes:
    //    [
    //      { text: "Child 1.1" }
    //    ] },
    //    { text: "Parent 2", nodes:
    //    [
    //      { text: "Child 2.1" }
    //    ] },
    //    { text: "Parent 3", nodes:
    //    [
    //      { text: "Child 3.1" },
    //      { text: "Child 3.2" }
    //    ] }
    // ]
    function getTagTree( ) {
        var json_str = "<%= JSON.generate Melcatalog.tag_hierarchy %>";
        json_str = json_str.replace(/&quot;/g, '"');
        return( jQuery.parseJSON( json_str ) );
    }
</script>

</body>