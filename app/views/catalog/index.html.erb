<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "application", :media => "all" %>
  <%= javascript_include_tag "application" %>
</head>
<body>

<div id="catalog-container">

  <h3 class="indent bottom-border">Search Melville Electronic Library</h3>

  <div id="new-search-panel" class="indent bottom-border">

    <div id="search-container">
       <label>Search for:</label><input id="search-term" value="<%= @search_term %>"/>
       <button id="search-button" type="button" class="btn-default btn btn-default-primary">Go</button>
    </div>
    <div id="button-block">
       <label class="radio-inline"><input type="radio" name="searchtypes" id="search-both" value="people">Both</label>
       <label class="radio-inline"><input type="radio" name="searchtypes" id="search-people" value="people">People</label>
       <label class="radio-inline"><input type="radio" name="searchtypes" id="search-artwork" value="artwork">Artwork</label>
    </div>
  </div>

  <div id="results-container" class="indent">

      <div id="browse-panel" class="left">
        <label>Browse</label>
        <div id="tag-tree"></div>
      </div>

      <div id="results-panel" class="right">

        <label class="results-type-header">People</label>
            <table class="table table-striped table-bordered table-hover">
              <thead>
              <tr><th></th><th>Name</th><th>Birth</th><th>Death</th></tr>
              </thead>
              <% unless @search_results[:person].nil? %>
              <tbody data-link="row" class="rowlink">
                 <% @search_results[:person].each do | entry | %>
                  <tr><td><%= image_or_text entry['image_thumb'], '' %></td><td><a id="<%= entry['eid'] %>" class="clickable" title="<%= entry['name'] %>" ref="<%= entry['image_thumb'] %>"><%= entry['name'] %></a></td><td><%= entry['birth'] %></td><td><%= entry['death'] %></td></tr>
                 <% end %>
              </tbody>
              <% end %>
            </table>

        <label class="results-type-header">Artworks</label>
            <table class="table table-striped table-bordered table-hover">
              <thead>
                 <tr><th></th><th>Artist</th><th>Title</th></tr>
              </thead>
              <% unless @search_results[:artwork].nil? %>
              <tbody data-link="row" class="rowlink">
                <% @search_results[:artwork].each do | entry | %>
                   <tr><td><%= image_or_text entry['image_thumb'], '' %></td><td><a id="<%= entry['eid'] %>" class="clickable" title="<%= entry['title'] %>" ref="<%= entry['image_thumb'] %>"><%= entry['artist'] %></a></td><td><%= entry['title'] %></td></tr>
                <% end %>
              </tbody>
              <% end %>
            </table>
      </div>

  </div>
</div>

<script type="text/javascript">

    $('document').ready(function( ) {

        //
        // setup correct search radio buttons
        //
        <% if ( @search_types.include? :person ) && ( @search_types.include? :artwork ) %>
           $('#search-both').prop('checked', true);
        <% elsif @search_types.include? :person %>
           $('#search-people').prop('checked', true);
        <% elsif @search_types.include? :artwork %>
           $('#search-artwork').prop('checked', true);
        <% end %>

        // enable the tree view
        $('#tag-tree').treeview( { data: getTagTree( ), levels: 0, highlightSelected: false, nodeIcon: '' } );

        // search button handler
        $("#search-button").click(function() {
            var term = $('#search-term').val( );
            var include_people = $('#search-people').prop('checked') || $('#search-both').prop('checked' );
            var include_artwork = $('#search-artwork').prop('checked') || $('#search-both').prop('checked' );
            newSearch( term, include_people, include_artwork );
        });

        // any of the results we found
        $(".clickable").click(function() {
            // the eid and the entry title separated with a pipe character
            storeDetails( $(this).attr( "id") + "|" + $(this).attr( "title") + "|" + $(this).attr( "ref") );

            // the current window, hopefully we are in an iframe
            close( );
        });

        // when we select a tag
        $('#tag-tree').on('nodeSelected', function(event, node) {
            //alert( "Clicked tag");
        });
    });

    // doing a new search in the same frame
    function newSearch( term, include_people, include_artwork ) {
        var include = "";
        if( include_people ) { include = "people"; }
        if( include_artwork ) { include = ( include ? include + "," : "" ) + "artwork"; }
        var newURL = "/documents/catalog?term=" + encodeURI( term ) + ( include ? "&types=" + include : "" );
        document.location.href = newURL;
    }

    // store the inserted item off so it is available to our parent (the opener)
    function storeDetails( reference ) {
       var div = window.opener.jQuery('div')[ 0 ];
       window.opener.jQuery.data( div, "catalog", reference );
    }

    //
    // the tree view needs an array of json objects. Something like:
    //
    // [ { text: "Parent 1", nodes:
    //    [
    //      { text: "Child 1.1" }
    //    ] },
    //    { text: "Parent 2", nodes:
    //    [
    //      { text: "Child 2.1" }
    //    ] },
    //    { text: "Parent 3", nodes:
    //    [
    //      { text: "Child 3.1" },
    //      { text: "Child 3.2" }
    //    ] }
    // ]
    function getTagTree( ) {
        var json_str = "<%= JSON.generate Melcatalog.aat_hierarchy %>";
        json_str = json_str.replace(/&quot;/g, '"');
        return( jQuery.parseJSON( json_str ) );
    }
</script>

</body>