<%= content_for :body_id, 'dashboard' %>
<%= content_for :body_class, 'index' %>
<%= content_for :page_title, 'Dashboard' %>
<%= stylesheet_link_tag "users" %>
<%= render "/shared/document_titles" %>

<div class="dropdown">
  <button class="dropbtn">Documents <span class="badge" style="display:inline-block"><%= @sharedDocsCount + current_user.documents.size %></span> </button>

  <div class="dropdown-content">
    <a href= "<%= dashboard_path(nav: 'mydocuments')%>" id="documents-mine" style="display:inline" >Mine <span class="badge"> <%= current_user.documents.size %></span></a>
    <a href= "<%= dashboard_path(nav: 'shareddocuments')%>" id="documents-shared" style="display:inline">Shared <span class="badge"> <%= @sharedDocsCount %></span></a>
    <a href="<%= new_document_path %>" style="display:inline" >New</a>
  </div>
</div>

<div class="dropdown">
  <button class="dropbtn" id="annotation-button">Annotations <span class="badge"></span></button>
  <div class="dropdown-content">
    <a id= "annotations-mine" style="display:inline"> Mine <span class="badge"></span></a>
    <a id="annotations-shared" style="display:inline">Shared <span class="badge"></span></a>

  </div>

</div>


<div class="dropdown">
  <button class="dropbtn">Groups <span class="badge" style="display:inline-block"><%= @current_user.groups.size %></span></button>
  <div class="dropdown-content">

    <a href= "<%= dashboard_path(nav: 'mygroups')%>" id="groups-mine" style="display:inline">Mine <span class="badge"> <%= @mygroups.size %></span> </a>
    <a href= "<%= dashboard_path(nav: 'joinedgroups')%>" id="groups-joined" style="display:inline">Joined <span class="badge"> <%= current_user.groups.size %></span></a>
    <a href="<%= new_group_path %>" style="display:inline">New</a>
    <a href="<%= groups_path %>" style="display:inline"> Join </a>

  </div>

  <div id="search-tab" class="dropdown" onclick="openSideMenu()"> <i class="glyphicon glyphicon-option-vertical" ></i> </div>
</div>

<!-- sidebar -->
<div id="side-menu" class="side-nav">
  <span class="glyphicon glyphicon-remove" onclick="closeSideMenu()"></span>
  <%= render "side_search_options" %>
</div>

<h4 id= "current-page"> Shared Documents </h4>


<div class= "content" id="my-docs">
  
</div><!--  end my-docs -->

<div class= "content" id="shared-docs">
  
  <div class="row">

  <% @newDoc = false%>
  <% @sharedDocs.each do |doc| %>

    <div class= "column"> 
       <span id="status-icon"> 
        <% case doc.state %>
          <% when 'draft' %>
            <i class="glyphicon glyphicon-pencil" title="<%= doc.state %>"></i>
          <% when 'published' %>
            <i class="glyphicon glyphicon-comment" title="<%= doc.state %>"></i>
          <% when 'archived' %>
            <i class="glyphicon glyphicon-folder-close" title="<%= doc.state %>"></i>
          <% when 'public' %>
            <i class="glyphicon glyphicon-globe" title="<%= doc.state %>"></i>
          <% else %>
            <%= doc.state %>
          <% end %>
       </span> 
       <span class="title"><%= link_to doc.title, document_path(id: doc.id) %> </span><br>
        <%= 'Author: '+ doc.author if doc.author != "" %> <br>
      
       Created: <%= doc.created_at.strftime("%m/%d/%Y") %> 
       <span style="font-size: 12px"> Groups: <%= doc.groups.pluck(:name) %> </span>
       <br>

       <%= link_to "Edit", controller: "documents", action: "edit", id: doc.id if doc.user == current_user %>
    </div> <!-- end column -->

    <!-- 'notifications' -->
    <% if doc.updated_at > current_user.last_sign_in_at && 
    doc.updated_at < current_user.current_sign_in_at &&
    doc.user_id != current_user.id %>
        <script> 
            console.log("new doc");
            $("#documents-shared").find(".badge").css("background-color", "#6caef5");
         </script>

    <% end %> <!-- end if -->
  <% end %> <!-- end doc loop -->

  </div>  <!-- end row -->
 

  <center><p>
    <div class='pagination-controls'>
      <%= will_paginate @sharedDocs, renderer: BootstrapPagination::Rails %>
    </div>
  </p>
</center>

</div><!--  end shared-docs -->

<div class = "content" id="my-annotations" style="display:none">
  <div id="my-annotation-list" class="row"></div>
</div>


<div class = "content" id="shared-annotations" style="display:none">
  <div id="class-annotation-list" class="row"></div>
</div>


<div class = "content" id="my-groups" style="display:none">
</div>

<div class = "content" id="joined-groups" style="display:none">
</div>



<script type="text/javascript">

// use href with a url param instead of onclick event. downside: reloads the page. 

   //a lot of repetition rn...clean up, or change page reload. need for pagination. 
  <% if params[:nav] && params[:nav] == 'mydocuments' %>

    var myDocuments = document.getElementById("my-docs");
    $(".content").hide(); //hide everything else 
    myDocuments.style.display = "block";
    $(myDocuments).html("<%= j render 'my_documents' %>");
    $("#current-page").text("My Documents");


  <% end %>


<% if params[:nav] && params[:nav] == 'shareddocuments' %>

    var sharedDocuments = document.getElementById("shared-docs");
    $(".content").hide();
    sharedDocuments.style.display = "block";
    $("#current-page").text("Shared Documents");

  <% end %>

  <% if params[:nav] && params[:nav] == 'mygroups' %>

    var mygroups = document.getElementById("my-groups");
    $(".content").hide();
    mygroups.style.display = "block";
    $(mygroups).html("<%= j render 'my_groups' %>");
    $("#current-page").text("My Groups");

  <% end %>

<% if params[:nav] && params[:nav] == 'joinedgroups' %>

    var joinedGroups = document.getElementById("joined-groups");
    $(".content").hide();
    joinedGroups.style.display = "block";
    $(joinedGroups).html("<%= j render 'joined_groups' %>");
    $("#current-page").text("Joined Groups");

  <% end %>

  $("#annotations-mine").click(function(){

    var myAnnotations = document.getElementById("my-annotations");
    $(".content").hide();
    myAnnotations.style.display = "block";
    $("#current-page").text("My Annotations");

    //update url params (problem: ruby doesn't actually see it rn..try to fix with AJAX!!!!!!
    window.history.pushState(null, null, "?nav=myannotations");
 
  }); //end click

  $("#annotations-shared").click(function(){

    var sharedAnnotations = document.getElementById("shared-annotations");
    $(".content").hide();
    sharedAnnotations.style.display = "block";
    $("#current-page").text("Shared Annotations");
     window.history.pushState(null, null, "?nav=sharedannotations");
  });
  

$("#documents-shared").click(function(event){
    $(".badge").css("background-color", "#777");

})

var active = false
//search animation stuff
function openSideMenu(){
  if (active){
    document.getElementById('side-menu').style.width = '0';
    active= false;
    return;
  }
  document.getElementById('side-menu').style.width = '350px';
  active = true
}

function closeSideMenu(){
  document.getElementById('side-menu').style.width = '0';
}


</script>


<style>

.dropbtn {
  background-color: white;
  padding: 5px;
  width: 150px;
  font-size: 16px;
  border: none;
}

.dropdown {
  position: relative;
  display: inline-block;
  padding-right: 100px;
}

.dropdown-content {
  /*margin-left: -100px;*/
  display: none;
  position: absolute;
  background-color: white;
  padding:5px;
  z-index: 1;
}

.dropdown-content a {
  color: black;
  padding: 5px 10px;
  text-decoration: none;
  display: block;
}


.dropdown-content a:hover {background-color: #FDE162;}

.dropdown:hover .dropdown-content {display: block;}

.dropdown:hover .dropbtn {background-color: #FDE162;}

.row{
  display:flex;
  flex-wrap: wrap;
}

.column{
  background-color: white;
  float: left;
  width: 15%;
  height: 200px;
  padding:5px;
  margin:10px 2% 0;
}

.title{
  text-overflow: ellipsis;
  max-width: 10px;
  overflow: hidden;
}

.current-page{
  margin-top: 5px;
  font-size: 12px;
}


#search-tab{
  margin-left: 100px;
  height:10%;
  background-color: #ddd;

}

.side-nav{
  height:100%;
  width:0;
  position:fixed;
  z-index:1;
  top:100px;
  right:0;
  background-color: white;
  overflow-x:hidden;
  text-decoration:none;
  transition:0.5s;
  padding-top: 10px;
}

.side-nav span{
  float:right;
  padding-right: 50px;
}


</style>



<%= javascript_include_tag "widget" %>
<script type="text/javascript" charset="utf-8">
jQuery(function ($) {
  var widget = new Widget.App();
  var endpoint = '<%= ENV["API_URL"] %>';
  var token = '<%= session["jwt"] %>';
  // Backbone.history.start({pushState: true, root: window.location})

var groups=[];

<% current_user.groups.each do |g| %>
  groups.push("<%=g.name %>");
<% end %>

  var myLoadOptions = {
    'limit': 20,
    'groups': "<%= current_user.rep_group_list %>".split(/, /),
    'subgroups': "<%= current_user.rep_subgroup_list %>".split(/, /),
    'host': location.host,
    'user': "<%= current_user.email %>",
    'mode': 'user',
    'context': 'dashboard',
  };
  var classLoadOptions = {
    'limit': 20,
    'groups': groups, //"<%= current_user.rep_group_list %>".split(/, /),
    'subgroups': "<%= current_user.rep_subgroup_list %>".split(/, /),
    'host': location.host,
    'user': "<%= current_user.email %>",
    'mode': 'class',
    'context': 'dashboard',
  };
  var groupLoadOptions = {
    'limit': 20,
    'groups': "<%= current_user.rep_group_list %>".split(/, /),
    'subgroups': "<%= current_user.rep_subgroup_list %>".split(/, /),
    'host': location.host,
    'user': "<%= current_user.email %>",
    'mode': 'group',
    'context': 'dashboard',
  };

  widget.listAnnotations('my-annotation-list', myLoadOptions, endpoint, token);
  widget.listAnnotations('class-annotation-list', classLoadOptions, endpoint, token);
  widget.listAnnotations('group-annotation-list', groupLoadOptions, endpoint, token);
});

</script>
<script type="text/template" id="user-comment-template">


  <span class="user-highlight" id="{{uuid}}">
  <div class="ellipsis"><a href="{{uri}}#hl{{uuid}}">"{{{quote}}}"</a></div>
  <hr>
</span>

<span class="user-comment"><div class="ellipsis">{{{text}}}</div>
  <span class= "annotation-info">{{formattedDate}} <br>
    Document: {{title}} <br>
    Annotator: {{username}}
  </span> 
  </span>
  
</script>